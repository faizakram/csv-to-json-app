ğŸ§± Unified Dockerfile (C:\ftp\scripts\Dockerfile)
# ===========================
# Base: Pure-FTPd with rclone + DNS
# ===========================
# ==========================================
# ğŸ§ Pure-FTPd + rclone + Auto Sync (Debian 12 Bookworm)
# ==========================================
FROM debian:bookworm-slim

# ---- System setup ----
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        pure-ftpd dnsutils curl unzip ca-certificates bash && \
    update-ca-certificates && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# ---- Install rclone ----
RUN curl -L https://downloads.rclone.org/rclone-current-linux-amd64.zip -o /tmp/rclone.zip && \
    unzip /tmp/rclone.zip -d /tmp && \
    cp /tmp/rclone-*/rclone /usr/bin/ && \
    chmod 755 /usr/bin/rclone && \
    rm -rf /tmp/*

# ---- Create folders ----
RUN mkdir -p /home/ftpusers/ftp-user /scripts /config

# ---- Copy upload hook ----
COPY on-upload.sh /scripts/on-upload.sh
RUN chmod +x /scripts/on-upload.sh

# ---- Copy startup script ----
COPY start.sh /start.sh
RUN chmod +x /start.sh

# ---- Set environment defaults ----
ENV FTP_USER_NAME=ftp-user \
    FTP_USER_PASS=ftp-pass \
    FTP_USER_HOME=/home/ftpusers/ftp-user \
    FTP_UPLOADSCRIPT=/scripts/on-upload.sh

# ---- Ports ----
EXPOSE 21 30000-30009

# ---- Entry point ----
ENTRYPOINT ["/start.sh"]


âš™ï¸ on-upload.sh

Save as: C:\ftp\scripts\on-upload.sh

#!/bin/sh
# --- Pure-FTPd upload hook ---
# $1 = file path, $4 = client IP

FILE_PATH="$1"
FILENAME="$(basename "$FILE_PATH")"
DIRNAME="$(dirname "$FILE_PATH")"
CLIENT_IP="$4"

CLIENT_HOST="$(nslookup "$CLIENT_IP" 2>/dev/null | awk '/name =/ {print $4}' | sed 's/\.$//')"
[ -z "$CLIENT_HOST" ] && CLIENT_HOST="UnknownHost"
CLIENT_NAME="$(echo "$CLIENT_HOST" | cut -d'.' -f1)"
PREFIX="${CLIENT_NAME}_${CLIENT_IP}"

TARGET_DIR="${DIRNAME}/${PREFIX}"
NEW_FILENAME="${PREFIX}_${FILENAME}"

mkdir -p "$TARGET_DIR"
mv "$FILE_PATH" "${TARGET_DIR}/${NEW_FILENAME}"

echo "$(date '+%F %T') Uploaded ${NEW_FILENAME} from ${CLIENT_IP}" >> /scripts/upload.log

# ===========================
# ENTRYPOINT LOGIC
# ===========================
# 1. Start FTP server in background
# 2. Run rclone sync loop (every 10s)
# ===========================
COPY start.sh /start.sh
RUN chmod +x /start.sh

ENTRYPOINT ["/start.sh"]

âš™ï¸ on-upload.sh (place in same folder)
#!/bin/sh
FILE_PATH="$1"
FILENAME="$(basename "$FILE_PATH")"
DIRNAME="$(dirname "$FILE_PATH")"
CLIENT_IP="$4"

CLIENT_HOST="$(nslookup "$CLIENT_IP" 2>/dev/null | awk '/name =/ {print $4}' | sed 's/\.$//')"
[ -z "$CLIENT_HOST" ] && CLIENT_HOST="UnknownHost"
CLIENT_NAME="$(echo "$CLIENT_HOST" | cut -d'.' -f1)"
PREFIX="${CLIENT_NAME}_${CLIENT_IP}"

TARGET_DIR="${DIRNAME}/${PREFIX}"
NEW_FILENAME="${PREFIX}_${FILENAME}"

mkdir -p "$TARGET_DIR"
mv "$FILE_PATH" "${TARGET_DIR}/${NEW_FILENAME}"

# Optional: log
echo "$(date): Uploaded ${NEW_FILENAME} from ${CLIENT_IP}" >> /scripts/upload.log

Save as: C:\ftp\scripts\start.sh

#!/bin/bash
set -e

echo "[INIT] Starting Pure-FTPd and rclone watcher..."

# Create FTP user dynamically
pure-pw useradd "$FTP_USER_NAME" -f /etc/pure-ftpd/pureftpd.passwd \
    -m -u ftpuser -d "$FTP_USER_HOME" -A "$FTP_USER_PASS" 2>/dev/null || true

# Ensure home directory exists
mkdir -p "$FTP_USER_HOME"

# Start FTP in background
pure-ftpd -E -j -R -p 30000:30009 &

sleep 5
echo "[OK] Pure-FTPd running."

# Continuous OneDrive sync
while true; do
  DATE=$(date +%Y-%m-%d)
  for dir in "$FTP_USER_HOME"/*; do
    [ -d "$dir" ] || continue
    CLIENT_DIR=$(basename "$dir")
    DEST="onedrive:/FTPUploads/${CLIENT_DIR}/${DATE}"
    rclone move "$dir" "$DEST" \
      --delete-empty-src-dirs \
      --create-empty-src-dirs \
      --log-file /config/upload.log \
      --log-level INFO || echo "[WARN] rclone failed for $CLIENT_DIR"
  done
  sleep 10
done

âš™ï¸ start.sh (place in same folder)
#!/bin/bash
set -e

# Start Pure-FTPd server in background
pure-ftpd -E -j -R -P 0.0.0.0 -p 30000:30009 &

# Wait for FTP to start
sleep 5
echo "[INIT] Pure-FTPd started."

# Run continuous OneDrive sync every 10 seconds
while true; do
  DATE=$(date +%Y-%m-%d)
  for dir in /home/ftpusers/ftp-user/*; do
    [ -d "$dir" ] || continue
    CLIENT_DIR=$(basename "$dir")
    DEST="onedrive:/FTPUploads/${CLIENT_DIR}/${DATE}"
    rclone move "$dir" "$DEST" \
      --delete-empty-src-dirs \
      --create-empty-src-dirs \
      --log-file /config/upload.log \
      --log-level INFO
  done
  sleep 10
done

ğŸ—ï¸ Build the unified image
cd C:\ftp\scripts
docker build -t ftp-onedrive:auto .

ğŸš€ Run the container
docker run -d `
  --name ftp-onedrive `
  --restart unless-stopped `
  -e FTP_USER_NAME=ftp-user `
  -e FTP_USER_PASS=ftp-pass `
  -e FTP_USER_HOME=/home/ftpusers/ftp-user `
  -e FTP_UPLOADSCRIPT=/scripts/on-upload.sh `
  -p 21:21 -p 30000-30009:30000-30009 `
  -v C:\ftp\data:/home/ftpusers/ftp-user `
  -v C:\rclone-config:/config `
  ftp-onedrive:auto

ğŸ“‚ Folder Structure Summary
C:\ftp\
 â”œâ”€ data\
 â”œâ”€ scripts\
 â”‚   â”œâ”€ Dockerfile
 â”‚   â”œâ”€ on-upload.sh
 â”‚   â””â”€ start.sh
 â””â”€ rclone-config\
     â””â”€ rclone.conf

âœ… What You Get
Feature	Status
FTP uploads auto-rename by hostname/IP	âœ…
OneDrive sync every 10 s	âœ…
Auto-restart on reboot	âœ…
Single container only	âœ…
Local logging	/config/upload.log + /scripts/upload.log
Works even without reverse DNS	âœ…


docker run -d `
  --name ftp-onedrive `
  --restart unless-stopped `
  -p 21:21 -p 30000-30009:30000-30009 `
  -v C:\ftp\data:/home/ftpusers/ftp-user `
  -v C:\ftp\scripts:/scripts `
  -v C:\rclone-config:/config `
  ftp-onedrive:auto

